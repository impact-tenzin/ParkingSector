<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="">

		<title>ParkingSector.bg | Времето ни е ценно!</title>

		<!-- Bootstrap core CSS -->
		<link href="/static/bootstrap/css/bootstrap.css" rel="stylesheet">

		<!-- Custom Google Web Font -->
		<link href="/static/bootstrap/font-awesome-4.1.0/css/font-awesome.min.css" rel="stylesheet">
		<link href='http://fonts.googleapis.com/css?family=Lato:100,300,400,700,900,100italic,300italic,400italic,700italic,900italic' rel='stylesheet' type='text/css'>

		<!-- Add custom CSS here -->
		<link href="/static/css/style.css" rel="stylesheet">
		<link href="/static/css/client_tasks.css" rel="stylesheet">
	</head>

	<body>

		<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="#">ParkingSector.bg</a>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse navbar-right navbar-ex1-collapse">
					<ul class="nav navbar-nav">
						<li>
							<a href="http://www.test.parkingsector.bg/#home" class="btn-one">Начало</a>
						</li>
						<li>
							<a href="http://www.test.parkingsector.bg/#services" class="btn-two">Услуги</a>
						</li>
						<li>
							<a href="http://www.test.parkingsector.bg/#contact" class="btn-three">Контакти</a>
						</li>
						<li>
							{% if user.is_authenticated %}
							<a href="#" class="btn-three" id="dropdownMenu1" data-toggle="dropdown">{{ user.username }}</a>
							{% else %}
							<a href="#" class="btn-three" id="dropdownMenu1" data-toggle="dropdown">Logout</a>
							{% endif %}

							<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
								<li role="presentation">
									<a href="/logout" role="menuitem" tabindex="-1" href="#"><i class="fa fa-power-off"></i> Изход</a>
								</li>
							</ul>
						</li>
						<!--<li><a href="http://www.test.parkingsector.bg/logout" class="btn-three">Излез</a>
						</li>-->
					</ul>
				</div>
				<!-- /.navbar-collapse -->
			</div>
			<!-- /.container -->
		</nav>

		<!--Three columns-->
		<div id="services" class="services">
			<!--Number plates-->
			<div class="container">
				<div class="row">
					<div class="col-md-4 col-md-offset-4 text-center">
						<h3 class="colorBlack">Регистрационни номера на автомобили</h3>
						<hr>
						<p class="msg alert">
							<i class="fa fa-exclamation-triangle"></i> Не сте запазили паркоместа
						</p>
						<br>
					</div>
				</div>
				<div class="col-lg-6 text-center first">

					<p class="label">
						Добавяне на номер:
					</p>
						<input type="text" name="your-email" placeholder="Рег. номер" class="cform-text regplateinput" size="40" title="your email">

						<button class="cform-submit submitBtn" onclick='addNewPlate();'>
							Запомни
						</button>

				</div>
				<div class="col-lg-4 text-center">

					<p class="label" id="dropdownMenu1 label" data-toggle="dropdown">
						Моите номера <span class="caret"></span>
					</p>
					<ul class="dropdown-menu plates-menu" role="menu" aria-labelledby="dropdownMenu1">
						<!--<li role="presentation">
						<a href="#" role="menuitem" tabindex="-1" href="#">KT 8585 PC
						<button class="cform-submit deleteBtn">
						Премахни
						</button></a>
						</li>
						<li role="presentation">
						<a href="#" role="menuitem" tabindex="-1" href="#">PC 6162 PK
							<button class="cform-submit deleteBtn">
							Премахни
							</button>
							</a>
						</li>
						<li role="presentation">
						<a href="#" role="menuitem" tabindex="-1" href="#">BK 6859 KT
						<button class="cform-submit deleteBtn">
						Премахни
						</button></a>
						</li>-->
					</ul>

				</div>
			</div>
			<div class="container">
				<div class="row">
					<div class="col-md-4 col-md-offset-4 text-center">
						<h2>Запазвания</h2>
						<hr>
						<p class="msg alert">
							<i class="fa fa-exclamation-triangle"></i> Не сте запазили паркоместа
						</p>
					</div>
				</div>
				<div class="row requests-containter">
					<!--<div class="col-md-3 text-center margin">
					<div class="service-item clientHolder">
					<h3>Заявка 1</h3>
					<p><i class="fa fa-map-marker client"></i> ул. Димитър Благоев 123, Студентски град, София</p>
					<p><i class="fa fa-calendar client"></i> дата на запазване:<br> 14.05.2014</p>
					<p><i class="fa fa-clock-o client"></i>  запазено от 12:30 до 14:30 часа</p>
					<p><i class="fa fa-car client"></i> регистрационен номер: CA1658MH</p>
					<p><i class="fa fa-usd client"></i> запазено на цена:<br> 1.00 лв/час</p>
					<button class="delete">Откажи <i class="fa fa-times"></i></button>
					</div>
					</div>-->
				</div>
			</div>
		</div>
		<!--/Three columns-->
		<!-- /.intro-header -->
		<footer>
			<div class="container">
				<div class="row">
					<div class="col-lg-12">
						<ul class="list-inline">
							<li>
								<a href="http://www.test.parkingsector.bg/#home">Начало</a>
							</li>
							<li class="footer-menu-divider">
								&sdot;
							</li>
							<li>
								<a href="http://www.test.parkingsector.bg/#services">Услуги</a>
							</li>
							<li class="footer-menu-divider">
								&sdot;
							</li>
							<li>
								<a href="http://www.test.parkingsector.bg/#contact">Контакти</a>
							</li>
						</ul>
						<p class="copyright text-muted small">
							Copyright &copy; ParkingSector.bg 2014. All Rights Reserved
						</p>
					</div>
				</div>
			</div>
		</footer>

		<!-- JavaScript -->
		<script src="/static/bootstrap/js/jquery-1.10.2.js"></script>
		<script src="/static/bootstrap/js/bootstrap.js"></script>
		<script>
			function getBookingRequests() {
				$.ajax({
					url : "/getBookingRequests/",
					type : 'GET', //this is the default though, you don't actually need to always mention it
					xhrFields : {
						withCredentials : true
					},
					headers : {
						'X-Requested-With' : 'XMLHttpRequest'
					},
					success : function(data) {
						var requests = data.filter(function(item) {
							return item.model == "parkingclient.bookedspots";
						});
						var licence_plates = data.filter(function(item) {
							return item.model == "parkingclient.licenceplates";
						});
						renderPlates(licence_plates);
						renderRequests(requests);
					},
					error : function(error) {
						// Log any error.
						console.log("ERROR:", error);

					},
				});
			}

			function addNewPlate() {
				var newPlate = $('.regplateinput').val();
				$.ajax({
					url : "/addNewPlate/",
					type : 'POST', //this is the default though, you don't actually need to always mention it
					xhrFields : {
						withCredentials : true
					},
					headers : {
						'X-Requested-With' : 'XMLHttpRequest'
					},
					data : {
						licence_plate : newPlate,
						csrfmiddlewaretoken : '{{ csrf_token }}'
					},
					success : function(data) {
						renderMessage(data, self);
					},
					error : function(error) {
						// Log any error.
						console.log("ERROR:", error);

					},
				});
			}
	
			function cancelBooking(self) {
				var booking_id = self.id;
				$.ajax({
					url : "/cancelBooking/",
					type : 'POST', //this is the default though, you don't actually need to always mention it
					xhrFields : {
						withCredentials : true
					},
					headers : {
						'X-Requested-With' : 'XMLHttpRequest'
					},
					data : {
						booking_id : booking_id,
						csrfmiddlewaretoken : '{{ csrf_token }}'
					},
					success : function(data) {
						renderMessage(data, self);
					},
					error : function(error) {
						// Log any error.
						console.log("ERROR:", error);

					},
				});
			}
			
			function removePlate(self) {
				var plate_id = self.id;
				$.ajax({
					url : "/removeLicencePlate/",
					type : 'POST', //this is the default though, you don't actually need to always mention it
					xhrFields : {
						withCredentials : true
					},
					headers : {
						'X-Requested-With' : 'XMLHttpRequest'
					},
					data : {
						plate_id : plate_id,
						csrfmiddlewaretoken : '{{ csrf_token }}'
					},
					success : function(data) {
						renderMessageForPlate(data, self);
					},
					error : function(error) {
						// Log any error.
						console.log("ERROR:", error);

					},
				});
			}
			
			function renderMessageForPlate(data, self) {
				if (data == "deletion complete") {
					$('.msg').html("").html("<i class='fa fa-check'></i> Отменихте заявката си успешно.");
					removePlateUI(self);
				}
				if (data == "BookedSpot does not exist")
					$('.msg').html("").html("<i class='fa fa-exclamation-triangle'></i> Установихме грешка. Моля, обновете сесията чрез рефреш!");
				if (data == "request method is not POST")
					$('.msg').html("").html("<i class='fa fa-exclamation-triangle'></i> Установихме грешка. Моля, пробвайте отново.");
				if (data == "user not authenticated")
					$('.msg').html("").html("<i class='fa fa-exclamation-triangle'></i> Не сте влезли в профила си.");
			}
			
			function renderMessage(data, self) {
				if (data == "deletion complete") {
					$('.msg').html("").html("<i class='fa fa-check'></i> Отменихте заявката си успешно.");
					removeWindow(self);
				}
				if (data == "BookedSpot does not exist")
					$('.msg').html("").html("<i class='fa fa-exclamation-triangle'></i> Установихме грешка. Моля, обновете сесията чрез рефреш!");
				if (data == "request method is not POST")
					$('.msg').html("").html("<i class='fa fa-exclamation-triangle'></i> Установихме грешка. Моля, пробвайте отново.");
				if (data == "user not authenticated")
					$('.msg').html("").html("<i class='fa fa-exclamation-triangle'></i> Не сте влезли в профила си.");
			}
			
			function removePlateUI(self) {
				var list = document.getElementsByClassName('plates-menu')[0];
				var toBeRemoved = self.parentNode.parentNode;
				//console.log(toBeRemoved);
				//console.log(list);
				list.removeChild(toBeRemoved);
			}
			
			function removeWindow(self) {
				var list = document.getElementsByClassName('requests-containter')[0];
				var toBeRemoved = self.parentNode.parentNode;
				//console.log(toBeRemoved);
				//console.log(list);
				list.removeChild(toBeRemoved);
			}

			function renderRequests(requests) {
				$('.requests-container').html("");
				for (var i = 0, len = requests.length; i < len; i++) {
					addRequestOnUI(requests[i]);
				};
			}

			function addRequestOnUI(request) {
				var uiRequest = "<div class='col-md-3 text-center margin'>" + "<div class='service-item clientHolder'>" + "<h3>Запазване</h3>" + "<p><i class='fa fa-map-marker client'></i>" + request.fields['parking_address'] + "</p>" + "<p><i class='fa fa-calendar client'></i>дата и час на запазване:<br>" + request.fields['arrival_time'] + "</p>" + "<p><i class='fa fa-clock-o client'></i> продължителност на престоя: " + request.fields['duration'] + " часа</p>" + "<p><i class='fa fa-car client'></i> регистрационен номер: " + request.fields['licence_plate'] + "</p>" + "<p><i class='fa fa-usd client'></i> запазено на цена:<br>" + request.fields['price_list'] + "</p>" + "<button id='" + request.pk + "' class='delete' onclick='cancelBooking(this)'>Откажи <i class='fa fa-times'></i></button>" + "</div>" + "</div>";
				$('.requests-containter').append(uiRequest);
			}

			function renderPlates(plates) {
				$('.plates-menu').html("");
				for (var i = 0, len = plates.length; i < len; i++) {
					addPlateOnUI(plates[i]);
				};
			}

			function addPlateOnUI(plate) {
				var uiPlate=
				"<li role='presentation'><a href='#' role='menuitem' tabindex='-1' href='#'>"+plate.fields['licence_plate']+"<button id='"+plate.id+"' class='cform-submit deleteBtn' onclick='removePlate(this)'>Премахни</button></a></li>";
				$('.plates-menu').append(uiRequest);
			}


			window.onload = function() {
				getBookingRequests();
			};
		</script>
	</body>

</html>
